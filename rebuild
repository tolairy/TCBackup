#! /bin/sh

#bindir=@SQL_BINDIR@

cd /usr/bin
#./mysql -u root -p  $* -f <<END-OF-DATA
./mysql $* -f <<END-OF-DATA
CREATE DATABASE IF NOT EXISTS TCBackup;
USE TCBackup;
DROP TABLE IF EXISTS User;
DROP TABLE IF EXISTS Object;
DROP TABLE IF EXISTS Job;
DROP TABLE IF EXISTS File;
DROP TABLE IF EXISTS VersionFile;

CREATE TABLE User (
   UserId INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
   UserName TINYBLOB NOT NULL,
   Password TINYBLOB,
   LastLoginTime DATETIME DEFAULT 0,
   LastLogoutTime DATETIME DEFAULT 0,
   UNIQUE (UserName(128)),
   PRIMARY KEY(UserId)
   )ENGINE=MyISAM;
CREATE TABLE Object (
   ObjectId INTEGER UNSIGNED NOT NULL AUTO_INCREMENT,
   ObjectName TINYBLOB NOT NULL,
   UserId INTEGER UNSIGNED DEFAULT 0 REFERENCES User,
   FullCount INTEGER UNSIGNED DEFAULT 0,
   IncrementCount INTEGER UNSIGNED DEFAULT 0,
   LastBackupTime DATETIME DEFAULT 0,
   FileSet BLOB NOT NULL,
   PRIMARY KEY(ObjectId)
   )ENGINE=MyISAM;
CREATE TABLE Job (
   JobId BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
   JobType BINARY(1) NOT NULL,
   StartTime DATETIME DEFAULT 0,
   FinishTime DATETIME DEFAULT 0,
   FileCount BIGINT UNSIGNED DEFAULT 0,
   DataSize BIGINT UNSIGNED DEFAULT 0,
   UserId INTEGER UNSIGNED DEFAULT 0 REFERENCES User,
   ObjectId INTEGER UNSIGNED DEFAULT 0 REFERENCES Object,
   PRIMARY KEY(JobId)
   )ENGINE=MyISAM;
CREATE TABLE File (
   FileId BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
   JobId BIGINT UNSIGNED DEFAULT 0 REFERENCES Job,
   VersionCount INTEGER UNSIGNED DEFAULT 0,
   FilePath BLOB NOT NULL,
   HashCode TINYBLOB,
   Size BIGINT UNSIGNED DEFAULT 0,
   ModifiedTime DATETIME DEFAULT 0,
   PRIMARY KEY(FileId)
   )ENGINE=MyISAM;
CREATE TABLE VersionFile (
   FileId BIGINT UNSIGNED NOT NULL REFERENCES File,
   JobId BIGINT UNSIGNED DEFAULT 0 REFERENCES Job,
   FilePath BLOB NOT NULL,
   PRIMARY KEY(FileId,JobId)
   )ENGINE=MyISAM;

END-OF-DATA
#then
  echo "Rebuilding TCBckup MySQL tables succeeded."
#else
 # echo "Rebuilding DBHustBak MySQL tables failed."
#fi
#exit 0
